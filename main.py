import logging
import openpyxl
from aiogram import Bot, Dispatcher, executor, types
from aiogram.contrib.fsm_storage.memory import MemoryStorage
from aiogram.dispatcher import FSMContext
from aiogram.dispatcher.filters.state import State, StatesGroup
from aiogram.types import ContentType
import db
import config

API_TOKEN = config.telegram_token
logging.basicConfig(level=logging.INFO)
storage = MemoryStorage()
bot = Bot(token=API_TOKEN)
dp = Dispatcher(bot, storage=storage)


class States(StatesGroup):
    get_picture = State()
    get_price = State()
    get_title = State()
    get_description = State()
    get_phone_number = State()
    get_new_category_name = State()
    get_message_for_send = State()


@dp.message_handler(commands=['admin'], state= '*')
async def admin(message: types.Message, state: FSMContext):
    await state.finish()
    if message.from_user.id not in config.admin_ids:
        return
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton(text='–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏', callback_data='edit_categories'))
    kb.add(types.InlineKeyboardButton(text='–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º', callback_data='users_statistic'))
    kb.add(types.InlineKeyboardButton(text='–ü—Ä–æ–≤–µ—Å—Ç–∏ —Ä–∞—Å—Å—ã–ª–∫—É –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º', callback_data='send'))
    await message.answer('–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ', reply_markup=kb)


@dp.callback_query_handler(lambda query: query.data == 'admin_menu')
async def admin_call(callback_query: types.CallbackQuery, state: FSMContext):
    await state.finish()
    if callback_query.message.chat.id not in config.admin_ids:
        return
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton(text='–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏', callback_data='edit_categories'))
    kb.add(types.InlineKeyboardButton(text='–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º', callback_data='users_statistic'))
    kb.add(types.InlineKeyboardButton(text='–ü—Ä–æ–≤–µ—Å—Ç–∏ —Ä–∞—Å—Å—ã–ª–∫—É –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º', callback_data='send'))
    await callback_query.message.edit_text('–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ', reply_markup=kb)


@dp.callback_query_handler(lambda query: query.data == 'edit_categories')
async def edit_categories(callback_query: types.CallbackQuery, state: FSMContext):
    await state.finish()
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton(text='–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é', callback_data='add_category'))
    kb.add(types.InlineKeyboardButton(text='–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é', callback_data='delete_category'))
    kb.add(types.InlineKeyboardButton(text='üîô–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', callback_data='admin_menu'))
    await callback_query.message.edit_text('–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ', reply_markup=kb)


@dp.callback_query_handler(lambda query: query.data == 'add_category')
async def add_category(callback_query: types.CallbackQuery, state: FSMContext):
    await state.finish()
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton(text='üîô–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', callback_data='admin_menu'))
    await callback_query.message.edit_text('–ü—Ä–∏—à–ª–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', reply_markup=kb)
    await States.get_new_category_name.set()


@dp.message_handler(state=States.get_new_category_name)
async def new_category(message: types.Message, state: FSMContext):
    await state.finish()
    res = db.create_category(message.text)
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton(text='üîô–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', callback_data='admin_menu'))
    if res:
        await message.answer('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞.', reply_markup=kb)
        return
    await message.answer('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é, —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º.', reply_markup=kb)


@dp.callback_query_handler(lambda query: query.data == 'delete_category', state='*')
async def delete_category(callback_query: types.CallbackQuery, state: FSMContext):
    await state.finish()
    categories = db.get_categories()
    kb = types.InlineKeyboardMarkup()
    for category in categories:
        kb.add(types.InlineKeyboardButton(text=category.get('name'), callback_data=f'offer_remove_category_{category.get("id")}'))
    kb.add(types.InlineKeyboardButton(text='üîô–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', callback_data='admin_menu'))
    await callback_query.message.edit_text('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', reply_markup=kb)


@dp.callback_query_handler(lambda query: query.data.startswith('offer_remove_category_'), state='*')
async def remove_category(callback_query: types.CallbackQuery, state: FSMContext):
    category_id = int(callback_query.data.split('_')[-1])
    category_name = db.get_category_name(category_id)
    await state.finish()
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton(text='–î–∞', callback_data=f'remove_category_{category_id}'))
    kb.add(types.InlineKeyboardButton(text='–ù–µ—Ç', callback_data='cancel_remove_category'))
    await callback_query.message.edit_text(f'–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é {category_name}?', reply_markup=kb)


@dp.callback_query_handler(lambda query: query.data == 'cancel_remove_category', state='*')
async def cancel_remove_category(callback_query: types.CallbackQuery, state: FSMContext):
    await state.finish()
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton(text='üîô–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', callback_data='admin_menu'))
    await callback_query.message.edit_text('–£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ—Ç–º–µ–Ω–µ–Ω–æ.', reply_markup=kb)


@dp.callback_query_handler(lambda query: query.data.startswith('remove_category_'), state='*')
async def confirm_remove_category(callback_query: types.CallbackQuery, state: FSMContext):
    await state.finish()
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton(text='üîô–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', callback_data='admin_menu'))
    category_id = int(callback_query.data.split('_')[-1])
    db.remove_category(category_id)
    await callback_query.message.edit_text('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞.', reply_markup=kb)


@dp.callback_query_handler(lambda query: query.data == 'users_statistic', state='*')
async def users_statistic(callback_query: types.CallbackQuery, state: FSMContext):
    await state.finish()
    data = db.get_users()
    wb = openpyxl.Workbook()
    sh = wb.active
    sh.append(['Username', 'id', '–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π'])
    for i in data:
        sh.append(i)
    wb.save('users_statistic.xlsx')
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton(text='üîô–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', callback_data='admin_menu'))
    await callback_query.message.answer_document(types.InputFile('users_statistic.xlsx'), reply_markup=kb)
    await callback_query.message.edit_text('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∑–∞–≥—Ä—É–∂–µ–Ω–∞.')


@dp.callback_query_handler(lambda query: query.data == 'send', state='*')
async def send(callback_query: types.CallbackQuery, state: FSMContext):
    await state.finish()
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton(text='üîô–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', callback_data='admin_menu'))
    await callback_query.message.edit_text('–ü—Ä–∏—à–ª–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏', reply_markup=kb)
    await States.get_message_for_send.set()


@dp.message_handler(state=States.get_message_for_send, content_types=ContentType.ANY)
async def send_message(message: types.Message, state: FSMContext):
    for user in db.get_users():
        user_id = user[1]
        await bot.copy_message(chat_id=user_id, from_chat_id=message.chat.id, message_id=message.message_id)
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton(text='üîô–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', callback_data='admin_menu'))
    await message.answer('–†–∞—Å—Å—ã–ª–∫–∞ —É—Å–ø–µ—à–Ω–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞.', reply_markup=kb)
    await state.finish()


@dp.message_handler(commands=['start', 'menu', 'main'], state='*')
async def start(message: types.Message, state: FSMContext):
    await state.finish()
    if not db.check_user(message.chat.id):
        await message.answer(config.get_phone_number)
        return await States.get_phone_number.set()
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton(text='–ü–æ–∏—Å–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π', callback_data='search_items'))
    kb.add(types.InlineKeyboardButton(text='–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –æ—ä—è–≤–ª–µ–Ω–∏–µ', callback_data='create_item'))
    kb.add(types.InlineKeyboardButton(text='–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è', switch_inline_query_current_chat='myitems'))
    kb.add(types.InlineKeyboardButton(text='–ù–∞—à–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ', url=config.group_url))
    await message.answer(config.hello_message, reply_markup=kb)


@dp.callback_query_handler(lambda query: query.data == 'cancel', state='*')
async def cancel_remove(callback_query: types.CallbackQuery, state: FSMContext):
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton(text='üîô–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', callback_data='menu'))
    await state.finish()
    await callback_query.message.edit_text('–£–¥–∞–ª–µ–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω–æ', reply_markup=kb)


@dp.callback_query_handler(lambda query: query.data == 'menu', state='*')
async def main_callback(callback_query: types.CallbackQuery, state: FSMContext):
    await state.finish()
    if not db.check_user(callback_query.message.chat.id):
        await callback_query.message.edit_text(config.get_phone_number)
        return await States.get_phone_number.set()
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton(text='–ü–æ–∏—Å–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π', callback_data='search_items'))
    kb.add(types.InlineKeyboardButton(text='–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –æ—ä—è–≤–ª–µ–Ω–∏–µ', callback_data='create_item'))
    kb.add(types.InlineKeyboardButton(text='–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è', switch_inline_query_current_chat='myitems'))
    kb.add(types.InlineKeyboardButton(text='–ù–∞—à–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ', url=config.group_url))
    await callback_query.message.edit_text(config.hello_message, reply_markup=kb)


@dp.message_handler(commands=['item'], state='*')
async def show_item(message: types.Message, state: FSMContext):
    await state.finish()
    item_id = int(message.text.split(' ')[1])
    item = db.get_item_by_id(item_id)
    if not item:
        await message.answer('–û–±—ä—è–≤–ª–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –æ–Ω–æ –±—ã–ª–æ —É–¥–∞–ª–µ–Ω–æ.')
        return
    await message.answer_photo(photo=item.get('picture1_id'))
    await message.answer_photo(photo=item.get('picture2_id'))
    phone_number = db.get_phone_number(message.from_user.id)
    text= f'''
{item.get('name')}
–¶–µ–Ω–∞: {item.get('price')}‚ÇΩ
–û–ø–∏—Å–∞–Ω–∏–µ: {item.get('description')}
–¢–µ–ª–µ—Ñ–æ–Ω: {phone_number}
'''
    category_name = db.get_category_by_id(item.get('category_id'))
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton(text=category_name, switch_inline_query_current_chat=str(item.get('category_id'))))
    kb.add(types.InlineKeyboardButton(text='–î—Ä—É–≥–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', callback_data='search_items'))
    if message.from_user.id == item.get('creator_id') or message.from_user.id in config.admin_ids:
        kb.add(types.InlineKeyboardButton(text='–£–¥–∞–ª–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ', callback_data=f'offer_delete_item_{item_id}'))
    kb.add(types.InlineKeyboardButton('üîô–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', callback_data='menu'))
    await message.answer(text)
    text = config.after_item.replace('category_name', category_name)
    await message.answer(text, reply_markup=kb)


@dp.callback_query_handler(lambda query: query.data.startswith('offer_delete_item_'), state='*')
async def delete_item(callback_query: types.CallbackQuery, state: FSMContext):
    await state.finish()
    item_id = int(callback_query.data.split('_')[-1])
    item = db.get_item_by_id(item_id)
    text = f'''–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ {item.get('name')}?'''
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton(text='–î–∞', callback_data=f'delete_item_{item_id}'))
    kb.add(types.InlineKeyboardButton(text='–ù–µ—Ç', callback_data='cancel'))
    await callback_query.message.edit_text(text, reply_markup=kb)


@dp.callback_query_handler(lambda query: query.data.startswith('delete_item_'), state='*')
async def delete_item(callback_query: types.CallbackQuery, state: FSMContext):
    await state.finish()
    item_id = int(callback_query.data.split('_')[-1])
    db.remove_item_by_id(item_id)
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton(text='üîô–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', callback_data='menu'))
    await callback_query.message.edit_text('–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ', reply_markup=kb)


@dp.message_handler(state=States.get_phone_number)
async def get_phone_number(message: types.Message, state: FSMContext):
    await state.finish()
    db.add_user(message.from_user.id, message.from_user.username, message.text)
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton(text='–ü–æ–∏—Å–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π', callback_data='search_items'))
    kb.add(types.InlineKeyboardButton(text='–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –æ—ä—è–≤–ª–µ–Ω–∏–µ', callback_data='create_item'))
    kb.add(types.InlineKeyboardButton(text='–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è', switch_inline_query_current_chat='myitems'))
    kb.add(types.InlineKeyboardButton(text='–ù–∞—à–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ', url=config.group_url))
    await message.answer(config.hello_message, reply_markup=kb)


'''
–ü—Ä–æ—Ü–µ—Å—Å –ø–æ–∏—Å–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
'''


@dp.callback_query_handler(lambda query: query.data == 'search_items')
async def search_items(callback_query: types.CallbackQuery):
    await callback_query.answer()
    kb = types.InlineKeyboardMarkup()
    categories = db.get_categories()
    for category in categories:
        kb.add(types.InlineKeyboardButton(text=category.get('name'),
                                          switch_inline_query_current_chat=f'{category.get("id")}'))
    kb.add(types.InlineKeyboardButton(text='üîô–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', callback_data='menu'))
    await callback_query.message.edit_text(config.search_message, reply_markup=kb)


@dp.inline_handler()
async def look_category(inline_query: types.InlineQuery):
    query = inline_query.query
    if query == 'myitems':
        items = db.get_items_by_creator(inline_query.from_user.id)
    else:
        if query.isdigit():
            items = db.get_items_by_category(int(query))
        else:
            items = []
    if len(items) == 0:
        await inline_query.answer([], cache_time=60, is_personal=True,
                                  switch_pm_text=config.no_items, switch_pm_parameter='None')
        return
    answer = list()
    if not inline_query.offset:
        border = 0
    else:
        border = int(inline_query.offset)
    for item in items[border:border+50]:
        answer.append(types.InlineQueryResultArticle(

            id=item.get('id'),
            title=f'{item.get("name")}',
            description=f'{item.get("price")}‚ÇΩ | {item.get("description")}',
            input_message_content=types.InputTextMessageContent(f'/item {item.get("id")}'),
        ))
    await inline_query.answer(answer, cache_time=60, is_personal=True,
                              switch_pm_text=config.no_items, switch_pm_parameter='None')


''''
–ü—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è
'''


@dp.callback_query_handler(lambda query: query.data == 'create_item', state='*')
async def create_item(callback_query: types.CallbackQuery, state: FSMContext):
    await state.finish()
    kb = types.InlineKeyboardMarkup()
    categories = db.get_categories()
    for category in categories:
        kb.add(types.InlineKeyboardButton(text=category.get('name'),
                                          callback_data=f'create_category_{category.get("id")}'))
    await callback_query.answer()
    await callback_query.message.edit_text(config.search_message, reply_markup=kb)


@dp.callback_query_handler(lambda query: query.data.startswith('create_category_'), state='*')
async def choose_category(callback_query: types.CallbackQuery, state: FSMContext):
    await state.finish()
    async with state.proxy() as data:
        data['category_id'] = int(callback_query.data.split('_')[-1])
    await callback_query.answer()
    await callback_query.message.edit_text(config.send_title, reply_markup=None)
    await States.get_title.set()


@dp.message_handler(state=States.get_title)
async def get_title(message: types.Message, state: FSMContext):
    if len(message.text) > config.max_title_length:
        await message.answer(config.title_too_long)
        return
    async with state.proxy() as data:
        data['title'] = message.text
    await message.answer(config.send_description)
    await States.get_description.set()


@dp.message_handler(state=States.get_description)
async def get_description(message: types.Message, state: FSMContext):
    if len(message.text) > config.max_description_length:
        await message.answer(config.description_too_long)
        return
    async with state.proxy() as data:
        data['description'] = message.text
    await message.answer(config.send_price)
    await States.get_price.set()


@dp.message_handler(state=States.get_price)
async def get_price(message: types.Message, state: FSMContext):
    if not message.text.isdigit():
        await message.answer(config.invalid_price)
        return
    async with state.proxy() as data:
        data['price'] = int(message.text)
    await States.get_picture.set()
    await message.answer(config.send_picture)


@dp.message_handler(content_types=ContentType.PHOTO, state=States.get_picture)
async def get_picture(message: types.Message, state: FSMContext):
    async with state.proxy() as data:
        if data.get('picture1'):
            data['picture2'] = message.photo[-1].file_id
            item_data = {'creator_id': message.from_user.id,
                         'category_id': data.get('category_id'),
                         'title': data.get('title'),
                         'description': data.get('description'),
                         'price': data.get('price'),
                         'picture1': data.get('picture1'),
                         'picture2': data.get('picture2')}
            db.create_item(item_data)
            await message.answer(config.item_created)
            await state.finish()
            await start(message, state)
        else:
            data['picture1'] = message.photo[-1].file_id
            await message.answer(config.send_picture2)


if __name__ == '__main__':
    db.start_db()
    executor.start_polling(dp, skip_updates=True)